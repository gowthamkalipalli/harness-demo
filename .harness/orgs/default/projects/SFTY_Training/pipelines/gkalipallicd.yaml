pipeline:
  name: Complete-CICD-Pipeline
  identifier: Complete_CICD_Pipeline
  description: This pipeline was generated by Harness AI on 2025-12-22 11:24:43 UTC by Gowtham.
  projectIdentifier: SFTY_Training
  orgIdentifier: default
  properties:
    ci:
      codebase:
        connectorRef: github-connector
        build:
          type: branch
          spec:
            branch: <+input>
  variables:
    - name: docker_image_tag
      type: String
      value: <+pipeline.sequenceId>
    - name: docker_image_name
      type: String
      value: <+input>
    - name: manifest_repo_path
      type: String
      value: <+input>
  stages:
    - stage:
        identifier: ci_stage
        name: CI Stage
        type: CI
        spec:
          cloneCodebase: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          caching:
            enabled: true
          execution:
            steps:
              - step:
                  type: Run
                  name: Build Application
                  identifier: build_application
                  spec:
                    connectorRef: account.harnessImage
                    image: alpine
                    shell: Bash
                    command: |
                      # Install build dependencies if needed
                      echo "Installing build dependencies..."
                      apk add --no-cache build-base make git

                      # Set up build environment
                      echo "Setting up build environment..."
                      export BUILD_NUMBER=<+pipeline.sequenceId>

                      # Execute build commands
                      echo "Building application..."

                      # Example build commands - modify based on your project type
                      if [ -f "pom.xml" ]; then
                        # Java/Maven project
                        apk add --no-cache maven openjdk11
                        mvn clean package -DskipTests
                        export BUILD_OUTPUT="target"
                      elif [ -f "build.gradle" ]; then
                        # Gradle project
                        apk add --no-cache gradle openjdk11
                        gradle build -x test
                        export BUILD_OUTPUT="build/libs"
                      elif [ -f "package.json" ]; then
                        # Node.js project
                        apk add --no-cache nodejs npm
                        npm install
                        npm run build
                        export BUILD_OUTPUT="dist"
                      else
                        echo "No recognized build file found. Using generic build command."
                        make build || echo "Using default build process"
                        export BUILD_OUTPUT="build"
                      fi

                      echo "Build completed successfully"
                      echo "Build artifacts available in $BUILD_OUTPUT"
                    envVariables:
                      CI: "true"
                      BUILD_ENV: harness
                    outputVariables:
                      - name: BUILD_OUTPUT
                      - name: BUILD_NUMBER
                  timeout: 10m
              - step:
                  type: Test
                  name: Run Unit Tests
                  identifier: run_unit_tests
                  timeout: 10m
                  spec:
                    command: |
                      # Run unit tests with test intelligence enabled
                      echo "Running unit tests with test intelligence..."
                      npm test -- --selectiveTests

                      # Generate code coverage report
                      echo "Generating code coverage report..."
                      npm run coverage
                    shell: Bash
                    connectorRef: account.harnessImage
                    image: alpine
                    privileged: false
                    envVariables:
                      TEST_INTELLIGENCE_ENABLED: "true"
                      NODE_ENV: test
                    reports:
                      type: JUnit
                      spec:
                        paths:
                          - "**/test-results/*.xml"
                          - "**/junit-reports/*.xml"
                    outputVariables:
                      - name: testsPassed
                      - name: coveragePercentage
              - step:
                  identifier: sonarqube_scan
                  name: SonarQube Scan
                  type: Sonarqube
                  timeout: 10m
                  spec:
                    mode: orchestration
                    config: default
                    connectorRef: <+input>
                    target:
                      type: repository
                      detection: auto
                    advanced:
                      fail_on_severity: high
                    tool:
                      project_key: <+pipeline.properties.ci.codebase.repoName>
                      branch_name: <+pipeline.properties.ci.codebase.build.spec.branch>
              - step:
                  identifier: build_and_push_docker
                  name: Build and Push Docker
                  type: BuildAndPushDockerRegistry
                  timeout: 10m
                  spec:
                    connectorRef: <+input>
                    repo: <+pipeline.variables.docker_image_name>
                    tags:
                      - <+pipeline.variables.docker_image_tag>
                    dockerfile: Dockerfile
                    context: .
                    caching: true
              - step:
                  identifier: scan_docker_image
                  name: Scan Docker Image
                  type: AquaTrivy
                  timeout: 10m
                  spec:
                    mode: orchestration
                    config: default
                    target:
                      type: container
                      name: <+pipeline.variables.docker_image_name>:<+pipeline.variables.docker_image_tag>
                    advanced:
                      fail_on_severity: critical
                    privileged: true
            rollbackSteps: []
    - stage:
        identifier: security_tests_stage
        name: Security Tests Stage
        type: SecurityTests
        spec:
          cloneCodebase: false
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  identifier: docker_image_scan
                  name: Docker Image Scan
                  type: AquaTrivy
                  timeout: 10m
                  spec:
                    mode: orchestration
                    config: default
                    target:
                      type: container
                      name: <+pipeline.variables.docker_image_name>:<+pipeline.variables.docker_image_tag>
                    connectorRef: <+input>
                    advanced:
                      fail_on_severity: critical
            rollbackSteps: []
    - stage:
        identifier: approval_stage
        name: Approval Stage
        type: Approval
        spec:
          execution:
            steps:
              - step:
                  identifier: manual_approval
                  name: Manual Approval
                  type: HarnessApproval
                  spec:
                    approvalMessage: Please approve this deployment to production environment
                    approvers:
                      disallowPipelineExecutor: true
                      minimumCount: 1
                      userGroups: <+input>
                    includePipelineExecutionHistory: true
                  timeout: 10m
            rollbackSteps: []
    - stage:
        name: Deploy to Staging
        identifier: deploy_to_staging
        type: Deployment
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: StageRollback
        spec:
          deploymentType: Kubernetes
          service:
            serviceRef: <+input>
          environment:
            environmentRef: <+input>
            deployToAll: false
            infrastructureDefinitions: <+input>
          execution:
            steps:
              - step:
                  identifier: k8s_rolling_deploy
                  name: K8s Rolling Deploy
                  type: K8sRollingDeploy
                  spec:
                    pruningEnabled: false
                    skipDryRun: false
                    delegateSelectors: []
                  timeout: 10m
            rollbackSteps:
              - step:
                  identifier: k8s_rolling_rollback
                  name: K8s Rolling Rollback
                  type: K8sRollingRollback
                  spec:
                    delegateSelectors: []
                    pruningEnabled: false
                  timeout: 10m
    - stage:
        name: Deploy to Production
        identifier: deploy_to_production
        type: Deployment
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: StageRollback
        spec:
          deploymentType: Kubernetes
          service:
            serviceRef: <+input>
          environment:
            environmentRef: <+input>
            deployToAll: false
            infrastructureDefinitions: <+input>
          execution:
            steps:
              - step:
                  identifier: k8s_rolling_deploy
                  name: K8s Rolling Deploy
                  type: K8sRollingDeploy
                  timeout: 10m
                  spec:
                    pruningEnabled: false
                    skipDryRun: false
            rollbackSteps:
              - step:
                  identifier: k8s_rolling_rollback
                  name: Kubernetes Rolling Rollback
                  type: K8sRollingRollback
                  timeout: 10m
                  spec:
                    pruningEnabled: false
                    delegateSelectors: []
                  when:
                    stageStatus: Failure
                    condition: <+execution.steps.step_1.status> == 'Failed'
  tags:
    ai_generated: "true"
